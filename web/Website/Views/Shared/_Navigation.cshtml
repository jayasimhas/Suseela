@inherits CustomGlassView<SideNavigationMenuViewModel>
@using Informa.Web.ViewModels;
@using Informa.Library.Navigation;
@using System.Diagnostics;
@using Informa.Library.Utilities.Extensions;

@{
 Stopwatch sw = Stopwatch.StartNew();
 }
@if (Model.MenuOpenFirstTime)
{
    <input type="hidden" class="menu-open-first-time-checked" value="@Model.MenuOpenFirstTime.ToString()" />
}

<div class="main-menu js-full-menu-toggle">
    <div class="menu-toggler js-menu-toggle-button">
        <button class="menu-toggler__button">
            <span>@Model.MenuButtonText</span>
        </button>
        @Model.MenuText
    </div>
    @if (Model.Navigation != null)
    {
        var Nav = new Navigation();
        var mainSubjectSectionClassName = "main-menu__section-title main-menu__hoverable js-toggle-menu-section is-active";
        var subscriptions = Model.ValidSubscriptions;
        foreach (var navigation in Model.Navigation.Where(n => !(n.Link == null && !n.Children.Any())))
        {
            Nav.Children = new List<Navigation>();
            //IPMP:283 subscriptions details
            var subscribedChildren = new List<INavigation>();
            if (subscriptions != null && subscriptions.Count() > 0)
            {
                foreach (var subscription in subscriptions)
                {
                    if (navigation.Children.Where(m => Model.PublicationCode + "." + m.Code == subscription.ProductCode).FirstOrDefault() != null)
                    {
                        subscribedChildren.Add(navigation.Children.Where(m => Model.PublicationCode + "." + m.Code == subscription.ProductCode).FirstOrDefault());
                    }
                }
                Nav.Children = subscribedChildren.Concat(navigation.Children.Where(m => !subscriptions.Any(n => n.ProductCode == Model.PublicationCode + "." + m.Code)));
            }
            else
            {
                Nav.Children = navigation.Children;
            }
            if (string.Equals(navigation.Code, "myview", StringComparison.OrdinalIgnoreCase) && Model.IsGlobalToggleEnabled)
            {
                Model.Preferencelst = Model.MyViewPreferences;
                if (Model.Preferencelst != null)
                {
                    Nav.Children = Model.Preferencelst.Children;
                    mainSubjectSectionClassName = Model.Preferencelst.Children.Any() ? "main-menu__section-title main-menu__hoverable js-toggle-menu-section" : "main-menu__section-title main-menu__hoverable js-toggle-menu-section is-active";

                }
            }
            if (navigation.Link == null && navigation.Text == null && Nav.Children.Any())
            {
                <dl class="main-menu__footer">
                    @foreach (var navigationChild in Nav.Children)
                    {
                        <dd class="main-menu__footer-link">
                            <a href="@navigationChild.Link.Url" class="click-utag" target="@navigationChild.Link.Target" data-info='{ "event_name" : "secondary_navigation","ga_eventCategory":"Secondary Navigation","ga_eventAction":"Side heading", "navigation_category": "Side heading","ga_eventLabel":"@navigationChild.Text", "click_through_destination": "@navigationChild.Text"}'>@navigationChild.Text</a>
                        </dd>
                    }
                    <dd class="bottomSpace"></dd>
                    <dd class="bottomSpace"></dd>
                    <dd class="bottomSpace"></dd>
                    <dd class="bottomSpace"></dd>
                    <dd class="bottomSpace"></dd>

                </dl>
            }
            else if (string.Equals(navigation.Code, "myview", StringComparison.OrdinalIgnoreCase) && Model.IsGlobalToggleEnabled)
            {

                <div class="main-menu__section">
                    <div class="titleMyView">@navigation.Text</div>
                    <ul>
                        @{var myViewHelpText = Nav.Children.Any() ? string.Empty : @Model.MyViewHelpText; }
                        @if (Model.IsAuthenticated)
                        {
                            <li class="edit-link"><a href="@Model.MyViewLinkURL" class="click-utag" data-info='{ "event_name" : "secondary_navigation", "ga_eventCategory":"Secondary Navigation","ga_eventAction":"@navigation.Text","ga_eventLabel":"Edit","navigation_category": "@navigation.Text", "click_through_destination": "Edit"}'>@Model.MyViewEditBtnText</a></li>
                            <li class="navContent">@myViewHelpText</li>
                        }
                        else
                        {

                            <li class="edit-link"><a id="myBtn" href="javascript: void(0);">@Model.MyViewEditBtnText</a></li>
                            <li class="navContent">@myViewHelpText</li>
                        }

                    </ul>
                    <ul>
                        @if (Nav.Children.Any())
                        {
                            foreach (var navigationChild in Nav.Children)
                            {
                                string activeClass = string.Empty;
                                if (!string.IsNullOrEmpty(navigationChild.Link?.TargetId.ToString()) && Model.CurrentItemId.Equals(navigationChild.Link.TargetId.ToString()))
                                {
                                    activeClass = "activate";
                                }
                                <li class="main-menu__hoverable @activeClass">
                                    <a href="@navigationChild.Link.Url" target="@navigationChild.Link.Target" class="main-menu__section-link myviewLink click-utag" name="@navigationChild.Link.TargetId.ToString()" data-info='{ "event_name" : "secondary_navigation","ga_eventCategory":"Secondary Navigation","ga_eventAction":"@navigation.Text", "navigation_category": "@navigation.Text","ga_eventLabel":"@navigationChild.Text", "click_through_destination": "@navigationChild.Text"}'>@navigationChild.Text</a>
                                </li>
                            }
                        }
                    </ul>

                </div>
                            }
                            else
                            {
                                if (!string.Equals(navigation.Code, "myview", StringComparison.OrdinalIgnoreCase))
                                {
                                    string activeClass = string.Empty;
                                    if (!string.IsNullOrEmpty(navigation.Link?.TargetId.ToString()) && Model.CurrentItemId.Equals(navigation.Link.TargetId.ToString()))
                                    {
                                        activeClass = "activate";
                                    }
                                    <ul class="main-menu__section">

                                        <li class="@mainSubjectSectionClassName @activeClass">
                                            @if (Model.Preferencelst != null ? Nav.Children.Where(p => !Model.Preferencelst.Children.Any(p2 => p2.Code == p.Code)).Any() : Nav.Children.Any())
                                            {
                                                <svg class="main-menu__arrow-icon  js-hoist-menu-click">
                                                    <use xlink:href="/dist/img/svg-sprite.svg#down-arrow"></use>
                                                </svg>
                                            }
                                            @if (navigation.Link == null)
                                            {
                                                @navigation.Text
                                            }
                                            else
                                            {
                                                <a href="@navigation.Link.Url" target="@navigation.Link.Target" class="click-utag" data-info='{ "event_name" : "secondary_navigation","ga_eventCategory":"Secondary Navigation","ga_eventAction":"@navigation.Text", "navigation_category": "@navigation.Text","ga_eventLabel":"@navigation.Text", "click_through_destination": "@navigation.Text"}'>@navigation.Text</a>
                                            }
                                        </li>

                                        @if (Nav.Children.Any())
                                        {
                                            <li class="main-menu__section-wrapper">
                                                <ul>
                                                    @foreach (var navigationChild in Model.Preferencelst != null ? Nav.Children.Where(p => !Model.Preferencelst.Children.Any(p2 => p2.Code == p.Code)) : Nav.Children)
                                                    {
                                                        string activeClassChild = string.Empty;
                                                        if (!string.IsNullOrEmpty(navigationChild.Link?.TargetId.ToString()) && Model.CurrentItemId.Equals(navigationChild.Link.TargetId.ToString()))
                                                        {
                                                            activeClassChild = "activate";
                                                        }
                                                        <li class="main-menu__hoverable @activeClassChild">
                                                            <a href="@navigationChild.Link.Url" target="@navigationChild.Link.Target" class="main-menu__section-link click-utag" data-info='{ "event_name" : "secondary_navigation","ga_eventCategory":"Secondary Navigation","ga_eventAction":"@navigation.Text", "navigation_category": "@navigation.Text","ga_eventLabel":"@navigationChild.Text", "click_through_destination": "@navigationChild.Text"}'>@navigationChild.Text</a>
                                                        </li>
                                                    }
                                                </ul>
                                            </li>
                                        }
                                    </ul>
                                        }
                                    }
                                }
                            }
</div>
<!-- The Personalised Modal -->
<div id="myModal" class="personalise_nav">

    <!-- Modal content -->
    <div class="personalise_nav-content">
        <span class="personalise_close">
            <svg class="dismiss-button__icon">
                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/dist/img/svg-sprite.svg#x"></use>
                UsernamePublicRestriction
            </svg>
        </span>
        @{ Html.RenderPartial("../Article/UserCallToAction", Model.CallToActionViewModel); }
    </div>

</div>

@{
Informa.Library.Utilities.Extensions.StringExtensions.WriteSitecoreLogs("Naviugation View End at :", sw, "SitemapService");
}